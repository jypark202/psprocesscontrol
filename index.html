<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>사내 공정 관리 캘린더</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; font-family:'Noto Sans KR',sans-serif; }
    /* ... (기존 스타일 생략) ... */
    .image-upload-container { display:flex; flex-direction:column; align-items:center; gap:0.25rem; }
    .thumbnail { width:60px; height:60px; object-fit:cover; cursor:pointer; border-radius:0.25rem; border:1px solid #ddd; }
  </style>
</head>
<body class="p-3">
  <!-- 헤더, 캘린더, 새작업 추가 버튼 등 동일 -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>사내 공정 관리 캘린더</h3>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newTaskModal">새작업 추가</button>
  </div>
  <table class="calendar">
    <!-- ... 캘린더 테이블 ... -->
  </table>

  <!-- 새 작업 모달 -->
  <div class="modal fade" id="newTaskModal" tabindex="-1">
    <!-- ... 폼 ... -->
  </div>

  <!-- 상세 정보 및 공정 현황 모달 -->
  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">상세 정보 및 공정 현황</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- 기본 정보 표 -->
          <table class="table table-bordered mb-4">
            <!-- ... -->
          </table>
          <!-- 공정 테이블 컨테이너 -->
          <div id="processTableContainer"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="deleteTask">삭제</button>
          <button class="btn btn-primary" id="saveChanges">저장</button>
        </div>
      </div>
    </div>
  </div>

  <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-50 d-none justify-content-center align-items-center">
    <div class="spinner-border text-primary"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let events = [], currentTask = null;

    document.addEventListener('DOMContentLoaded', () => {
      loadAndRender();
      document.getElementById('saveChanges').addEventListener('click', saveChanges);
      // ... 새작업 추가, 삭제 이벤트 바인딩 ...
    });

    function loadAndRender() {
      google.script.run.withSuccessHandler(data => {
        events = data;
        renderCalendar();
      }).getScheduleData();
    }

    function renderCalendar() {
      // ... 캘린더 렌더링 로직 ...
    }

    function openDetailModal(id) {
      currentTask = events.find(e => e.id === id);
      if (!currentTask) return;
      // 기본 정보 채우기...
      renderProcessTable(currentTask.processes);
      new bootstrap.Modal(document.getElementById('detailModal')).show();
    }

    function renderProcessTable(processes) {
      const container = document.getElementById('processTableContainer');
      container.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'table table-sm table-bordered process-table';
      // 헤더 생성...
      // 본문 생성
      Object.entries(processes).forEach(([groupName, group]) => {
        Object.entries(group.products).forEach(([productName, product]) => {
          Object.entries(product).forEach(([stepName, stepData]) => {
            const tr = document.createElement('tr');
            // 그룹명, 단계명 셀...
            const tdControls = document.createElement('td');
            
            // 1) 체크박스들...
            if (typeof stepData === 'object') {
              Object.entries(stepData).forEach(([key, val]) => {
                if (key === 'image') return;
                const lbl = document.createElement('label');
                lbl.className = 'form-check form-check-inline';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.className = 'form-check-input';
                cb.checked = val;
                cb.dataset.group = groupName;
                cb.dataset.product = productName;
                cb.dataset.step = stepName;
                cb.dataset.key = key;
                lbl.append(cb, document.createTextNode(key));
                tdControls.appendChild(lbl);
              });
            } else {
              // 텍스트 입력...
            }

            // 2) 이미지 업로드 버튼 + 숨겨진 input:file
            const imgWrap = document.createElement('div');
            imgWrap.className = 'image-upload-container';

            const uploadBtn = document.createElement('button');
            uploadBtn.type = 'button';
            uploadBtn.className = 'btn btn-outline-secondary btn-sm';
            uploadBtn.textContent = '+';
            imgWrap.append(uploadBtn);

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.capture = 'environment';        // 모바일 카메라 활성화
            fileInput.style.display = 'none';         // 숨김
            imgWrap.append(fileInput);

            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', e => {
              handleImageUpload(e, groupName, productName, stepName);
            });

            // 3) 썸네일 (이미 업로드된 게 있으면)
            const imgUrl = stepData.image;
            if (imgUrl) {
              const thumb = document.createElement('img');
              thumb.src = imgUrl;
              thumb.className = 'thumbnail';
              thumb.addEventListener('click', () => window.open(imgUrl, '_blank'));
              imgWrap.append(thumb);
            }

            tdControls.appendChild(imgWrap);
            tr.appendChild(tdControls);
            table.appendChild(tr);
          });
        });
        // 특이사항 row...
      });
      container.appendChild(table);
    }

    function handleImageUpload(evt, group, product, step) {
      const file = evt.target.files[0];
      if (!file || !currentTask) return;
      showSpinner(true);
      // 리사이즈 가능 시 추가하고...
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        // 서버로 업로드
        google.script.run.withSuccessHandler(url => {
          // 프로세스 데이터에 url 저장
          currentTask.processes[group].products[product][step].image = url;
          renderProcessTable(currentTask.processes);
          showSpinner(false);
        }).uploadImage({
          taskId: currentTask.id,
          group, product, step,
          dataUrl
        });
      };
      reader.readAsDataURL(file);
    }

    function saveChanges() {
      // 체크박스/입력값 모두 currentTask.processes 에 반영 후
      google.script.run.withSuccessHandler(() => {
        bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
        loadAndRender();
      }).saveProcessData(currentTask);
    }

    function showSpinner(show) {
      document.getElementById('loadingSpinner')
        .classList.toggle('d-none', !show);
    }
  </script>
</body>
</html>

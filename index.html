<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>사내 공정 관리 캘린더</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
    .calendar-day { min-height: 120px; }
    .event-item { font-size: 0.8rem; padding: 2px 4px; margin-bottom: 2px; border-radius: 4px; cursor: pointer; }
    #modal-content::-webkit-scrollbar { width: 8px; }
    #modal-content::-webkit-scrollbar-track { background: #f1f1f1; }
    #modal-content::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    #modal-content::-webkit-scrollbar-thumb:hover { background: #555; }
    .process-table th, .process-table td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: center; vertical-align: middle; }
    .checkbox-label { display: flex; align-items: center; margin-bottom: 0.5rem; white-space: nowrap; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="app" class="container mx-auto p-4 max-w-7xl">
    <!-- 간결하게 표현된 헤더 -->
    <div class="flex items-center justify-between mb-4 bg-white p-4 rounded-lg shadow">
      <div>
        <button id="prev-month" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">&lt; 이전</button>
        <button id="next-month" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 ml-2">다음 &gt;</button>
      </div>
      <h2 id="current-month-year" class="text-2xl font-bold text-gray-800"></h2>
      <button id="add-new-task-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">새 작업 추가</button>
    </div>

    <!-- 캘린더 -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="grid grid-cols-7 text-center font-semibold border-b">
        <div class="py-2 text-red-500">일</div><div class="py-2">월</div><div class="py-2">화</div><div class="py-2">수</div><div class="py-2">목</div><div class="py-2">금</div><div class="py-2 text-blue-500">토</div>
      </div>
      <div id="calendar-grid" class="grid calendar-grid"></div>
    </div>
    <div class="text-xs text-gray-500 mt-2">User ID: <span id="userId"></span></div>
  </div>

  <!-- 모달 등 기타 UI 컴포넌트 생략 -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const config = {
      apiKey: "AIzaSyCQgruas8LevqyFe7lLksypiVqWyWAEPiU",
      authDomain: "processcontrol-c965d.firebaseapp.com",
      projectId: "processcontrol-c965d"
    };

    const app = initializeApp(config);
    const auth = getAuth();
    const db = getFirestore();
    const appId = "process-control-app";
    let currentYear, currentMonth;
    let tasks = [], currentUserId = null;

    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthYearEl = document.getElementById('current-month-year');

    function renderCalendar(year, month) {
      currentYear = year; currentMonth = month;
      currentMonthYearEl.textContent = `${year}년 ${month + 1}월`;
      calendarGrid.innerHTML = '';
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
      const filteredTasks = tasks.filter(t => t.date.startsWith(monthStr));
      for (let i = 0; i < firstDay; i++) calendarGrid.appendChild(document.createElement('div'));
      for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day border-t border-l p-2';
        const dateStr = `${monthStr}-${String(day).padStart(2, '0')}`;
        const matchingTasks = filteredTasks.filter(t => t.date === dateStr);
        const dayNumber = document.createElement('span');
        dayNumber.textContent = day;
        dayNumber.className = 'text-sm';
        const today = new Date();
        if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === day) {
          dayNumber.classList.add('bg-blue-500', 'text-white', 'rounded-full', 'px-2');
        }
        dayEl.appendChild(dayNumber);
        matchingTasks.forEach(t => {
          const el = document.createElement('div');
          el.className = 'event-item bg-blue-100 text-blue-800';
          el.textContent = `${t.line} / ${t.unit}`;
          dayEl.appendChild(el);
        });
        calendarGrid.appendChild(dayEl);
      }
    }

    function subscribeToTasks() {
      const ref = collection(db, "apps", appId, "tasks");
      onSnapshot(ref, snapshot => {
        tasks = snapshot.docs.map(doc => doc.data());
        renderCalendar(currentYear, currentMonth);
      });
    }

    function startApp() {
      onAuthStateChanged(auth, user => {
        if (user) {
          currentUserId = user.uid;
          document.getElementById('userId').textContent = currentUserId;
          subscribeToTasks();
        } else {
          signInAnonymously(auth).catch(err => alert("로그인 오류: " + err.message));
        }
      });
    }

    const today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth();
    renderCalendar(currentYear, currentMonth);

    document.getElementById('prev-month').onclick = () => {
      currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar(currentYear, currentMonth);
    };
    document.getElementById('next-month').onclick = () => {
      currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar(currentYear, currentMonth);
    };

    startApp();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 공정 관리 캘린더</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { min-height: 100px; }
        .event-item { font-size: 0.8rem; padding: 2px 4px; margin-bottom: 2px; border-radius: 4px; cursor: pointer; }
        #modal-content::-webkit-scrollbar { width: 8px; height: 8px; }
        #modal-content::-webkit-scrollbar-track { background: #f1f1f1; }
        #modal-content::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        #modal-content::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .process-table { table-layout: fixed; }
        .process-table th, .process-table td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: center; vertical-align: middle; font-size: 0.8rem; white-space: nowrap; }
        .process-table .product-col { width: 200px; }
        .process-table thead th { background-color: #f8fafc; font-weight: 600; color: #334155; }
        .process-table .checkbox-label { display: flex; align-items: center; white-space: nowrap; }
        
        .sticky-header { position: sticky; top: -1px; z-index: 20; }
        .sticky-col { position: sticky; left: 0; z-index: 10; }
        .sticky-col-2 { position: sticky; left: 8.333333%; /* w-1/12 */ z-index: 10; }


        .date-input-filled {
            background-color: #e0f2fe; /* light-blue-100 */
            font-weight: 600;
            color: #0c4a6e; /* cyan-800 */
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app" class="container mx-auto p-4 max-w-screen-2xl">
        <!-- 헤더 -->
        <div class="flex items-center justify-between mb-4 bg-white p-4 rounded-lg shadow-sm">
            <div>
                <button id="prev-month" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">&lt; 이전</button>
                <button id="next-month" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 ml-2">다음 &gt;</button>
            </div>
            <h2 id="current-month-year" class="text-2xl font-bold text-slate-800"></h2>
            <div class="flex items-center gap-4">
                 <div id="sync-status" class="text-sm text-slate-500 flex items-center gap-2">
                    <div id="status-indicator" class="w-3 h-3 rounded-full bg-yellow-400"></div>
                    <span id="status-text">연결 중...</span>
                </div>
                <div class="flex gap-2">
                    <button id="add-baffle-plate-task-btn" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm text-center leading-tight">새작업 추가<br>(방착판)</button>
                    <button id="add-linear-task-btn" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm text-center leading-tight">새작업 추가<br>(리니어)</button>
                </div>
            </div>
        </div>

        <!-- 캘린더 -->
        <div id="calendar-container" class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="grid grid-cols-7 text-center font-semibold border-b">
                <div class="py-2 text-red-500">일</div><div class="py-2">월</div><div class="py-2">화</div><div class="py-2">수</div><div class="py-2">목</div><div class="py-2">금</div><div class="py-2 text-blue-500">토</div>
            </div>
            <div id="calendar-grid" class="grid calendar-grid"></div>
        </div>
        
        <div id="config-guide-container" class="hidden"></div>
    </div>

    <!-- 새 작업 추가 모달 -->
    <div id="new-task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="new-task-modal-title" class="text-xl font-bold">새 작업 추가</h3>
                <button id="close-new-task-modal" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div><label for="new-task-date" class="block text-sm font-medium text-slate-700">반입일자</label><input type="date" id="new-task-date" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm"></div>
                <div><label for="new-task-line" class="block text-sm font-medium text-slate-700">반입라인</label><input type="text" id="new-task-line" placeholder="예: A2" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm"></div>
                <div id="new-task-unit-wrapper"><label for="new-task-unit" class="block text-sm font-medium text-slate-700">반입호기</label><input type="text" id="new-task-unit" placeholder="예: 53호기" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm"></div>
                <div id="new-task-structure-wrapper"><label for="new-task-structure" class="block text-sm font-medium text-slate-700">반입구조</label><input type="text" id="new-task-structure" placeholder="예: DM0" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm"></div>
                <div><label for="new-task-notes" class="block text-sm font-medium text-slate-700">특이사항</label><input type="text" id="new-task-notes" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm"></div>
            </div>
            <div class="p-4 border-t flex justify-end"><button id="save-new-task-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">저장</button></div>
        </div>
    </div>

    <!-- 상세 정보 모달 -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-screen-xl max-h-[95vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold text-slate-800">상세 정보 및 공정 현황</h3>
                <button id="close-modal" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="p-6 overflow-auto bg-slate-50/50">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-md text-blue-600">기본 정보</h4>
                        <button id="edit-basic-info-btn" class="bg-slate-200 text-slate-700 px-3 py-1 rounded-md text-xs hover:bg-slate-300">수정</button>
                    </div>
                    <div id="basic-info-display" class="grid grid-cols-4 gap-x-6 gap-y-2 text-xs border p-3 rounded-md bg-white shadow-sm">
                        <div><strong>반입일자:</strong> <span id="modal-date"></span></div>
                        <div><strong>반입라인:</strong> <span id="modal-line"></span></div>
                        <div id="modal-unit-wrapper"><strong>반입호기:</strong> <span id="modal-unit"></span></div>
                        <div id="modal-structure-wrapper"><strong>반입구조:</strong> <span id="modal-structure"></span></div>
                        <div class="col-span-full"><strong>특이사항:</strong> <span id="modal-notes"></span></div>
                    </div>
                    <div id="basic-info-edit" class="hidden grid grid-cols-4 gap-x-6 gap-y-2 text-xs border p-3 rounded-md bg-white shadow-sm">
                        <div><label class="font-bold">반입일자</label><input type="date" id="edit-date" class="w-full border-slate-300 rounded-md p-1"></div>
                        <div><label class="font-bold">반입라인</label><input type="text" id="edit-line" class="w-full border-slate-300 rounded-md p-1"></div>
                        <div id="edit-unit-wrapper"><label class="font-bold">반입호기</label><input type="text" id="edit-unit" class="w-full border-slate-300 rounded-md p-1"></div>
                        <div id="edit-structure-wrapper"><label class="font-bold">반입구조</label><input type="text" id="edit-structure" class="w-full border-slate-300 rounded-md p-1"></div>
                        <div class="col-span-full"><label class="font-bold">특이사항</label><input type="text" id="edit-notes" class="w-full border-slate-300 rounded-md p-1"></div>
                    </div>
                </div>
                <div id="process-table-container"></div>
            </div>
            <div class="p-4 border-t flex justify-between items-center bg-slate-50">
                <button id="delete-task-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">작업 삭제</button>
                <button id="save-changes-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">공정 현황 저장</button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6"><p id="custom-modal-message" class="text-slate-700"></p></div>
            <div id="custom-modal-buttons" class="p-4 border-t flex justify-end gap-2">
                <button id="custom-modal-confirm" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">확인</button>
                <button id="custom-modal-cancel" class="bg-slate-300 text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-400">취소</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const userFirebaseConfig = {
            apiKey: "AIzaSyAcIM8AtD9pwtJHH9mqX3q1iDUIGOOUqZ4",
            authDomain: "psprocesscontrol.firebaseapp.com",
            projectId: "psprocesscontrol",
            storageBucket: "psprocesscontrol.appspot.com",
            messagingSenderId: "150463270722",
            appId: "1:150463270722:web:9d5ad3cff85edbab6cc2db",
            measurementId: "G-DQ0RGJRE8C"
        };

        const envFirebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : {};
        const firebaseConfig = envFirebaseConfig.projectId ? envFirebaseConfig : userFirebaseConfig;
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : 'default-app-id';
        let db, auth;

        document.addEventListener("DOMContentLoaded", function() {
            let currentYear, currentMonth;
            let tasks = [];
            let currentTask = null;
            let unsubscribe = null;
            let currentTaskType = 'baffle-plate';
            let visibleProducts = []; 
            let isEditingBasicInfo = false;

            const calendarGrid = document.getElementById('calendar-grid');
            const currentMonthYearEl = document.getElementById('current-month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const modal = document.getElementById('detail-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const newTaskModal = document.getElementById('new-task-modal');
            const closeNewTaskModalBtn = document.getElementById('close-new-task-modal');
            const saveNewTaskBtn = document.getElementById('save-new-task-btn');
            const saveChangesBtn = document.getElementById('save-changes-btn');
            const deleteTaskBtn = document.getElementById('delete-task-btn');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const addBafflePlateTaskBtn = document.getElementById('add-baffle-plate-task-btn');
            const addLinearTaskBtn = document.getElementById('add-linear-task-btn');
            const newTaskModalTitle = document.getElementById('new-task-modal-title');
            const unitWrapper = document.getElementById('new-task-unit-wrapper');
            const structureWrapper = document.getElementById('new-task-structure-wrapper');
            const modalUnitWrapper = document.getElementById('modal-unit-wrapper');
            const modalStructureWrapper = document.getElementById('modal-structure-wrapper');
            const editBasicInfoBtn = document.getElementById('edit-basic-info-btn');
            const basicInfoDisplay = document.getElementById('basic-info-display');
            const basicInfoEdit = document.getElementById('basic-info-edit');

            const bafflePlateProductNames = ["상판", "견시창", "각도판", "리플렉터", "구성품", "전수", "셋업"];
            const linearProductNames = ["BODY", "NOZZLE", "I/P"];
            
            const processDefinitions = [
                { groupName: "포승(부광)", color: "bg-blue-50", rows: [ { name: "상태", type: "checkbox", items: [ {label: "이동대기", hasDate: true}, {label: "이동중", hasDate: true}, {label: "이동완료", hasDate: true} ] }, { name: "특이사항", type: "textarea" } ] },
                { groupName: "현곡(인현)", color: "bg-green-50", rows: [ { name: "상태", type: "checkbox", items: [ {label: "입고완료", hasDate: true}, {label: "검사대기", hasDate: true}, {label: "검사완료", hasDate: true} ] }, { name: "특이사항", type: "textarea" } ] },
                { groupName: "현곡(TKG)", color: "bg-yellow-50", rows: [ { name: "상태", type: "checkbox", items: [ {label: "CR입고", hasDate: true}, {label: "오븐 시작일", hasDate: true}, {label: "오븐 완료일", hasDate: true}, {label: "포장 시작일", hasDate: true}, {label: "포장 완료일", hasDate: true}, {label: "외부 이동", hasDate: true} ] }, { name: "특이사항", type: "textarea" } ] },
                { groupName: "현곡(인현)_출하", color: "bg-orange-50", rows: [ { name: "상태", type: "checkbox", items: [ {label: "상차대기", hasDate: true}, {label: "상차중", hasDate: true}, {label: "상차완료", hasDate: true}, {label: "랩핑완료", hasDate: true}, {label: "출하장 이동", hasDate: true} ] }, { name: "특이사항", type: "textarea" } ] }
            ];

            const customModal = document.getElementById('custom-modal');
            const customModalMessage = document.getElementById('custom-modal-message');
            const customModalConfirmBtn = document.getElementById('custom-modal-confirm');
            const customModalCancelBtn = document.getElementById('custom-modal-cancel');
            
            function showCustomAlert(message) {
                customModalMessage.textContent = message;
                customModalConfirmBtn.style.display = 'inline-block';
                customModalCancelBtn.style.display = 'none';
                customModal.style.display = 'flex';
                return new Promise(resolve => { customModalConfirmBtn.onclick = () => { customModal.style.display = 'none'; resolve(true); }; });
            }

            function showCustomConfirm(message) {
                customModalMessage.textContent = message;
                customModalConfirmBtn.style.display = 'inline-block';
                customModalCancelBtn.style.display = 'inline-block';
                customModal.style.display = 'flex';
                return new Promise(resolve => {
                    customModalConfirmBtn.onclick = () => { customModal.style.display = 'none'; resolve(true); };
                    customModalCancelBtn.onclick = () => { customModal.style.display = 'none'; resolve(false); };
                });
            }
            
            async function saveTasks() {
                if (!db) return;
                const docRef = doc(db, `artifacts/${appId}/public/data/process-calendar`, "tasks");
                try { await setDoc(docRef, { tasks: tasks, updatedAt: serverTimestamp() }); }
                catch (error) { console.error("Firestore 업데이트 오류:", error); showCustomAlert("데이터 저장에 실패했습니다."); }
            }

            function listenToTasks() {
                if (unsubscribe) unsubscribe(); 
                const docRef = doc(db, `artifacts/${appId}/public/data/process-calendar`, "tasks");
                unsubscribe = onSnapshot(docRef, (snapshot) => {
                    tasks = snapshot.exists() ? snapshot.data().tasks || [] : [];
                    renderCalendar(currentYear, currentMonth);
                    statusIndicator.classList.remove('bg-yellow-400', 'bg-red-500');
                    statusIndicator.classList.add('bg-green-500');
                    statusText.textContent = '실시간 동기화 중';
                }, (error) => {
                    console.error("Firestore 구독 오류:", error);
                    statusIndicator.classList.remove('bg-yellow-400', 'bg-green-500');
                    statusIndicator.classList.add('bg-red-500');
                    statusText.textContent = '연결 오류';
                });
            }
            
            function generateProcessData(taskType) {
                const productNames = taskType === 'linear' ? linearProductNames : bafflePlateProductNames;
                const processes = {};
                processDefinitions.forEach(groupDef => {
                    const groupName = groupDef.groupName;
                    processes[groupName] = { products: {} };
                    productNames.forEach(productName => {
                        processes[groupName].products[productName] = {};
                        groupDef.rows.forEach(rowDef => {
                            const rowName = rowDef.name;
                            if (rowDef.type === 'checkbox') {
                                processes[groupName].products[productName][rowName] = {};
                                rowDef.items.forEach(item => { 
                                    processes[groupName].products[productName][rowName][item.label] = { checked: false, date: "" };
                                });
                            } else {
                                processes[groupName].products[productName][rowName] = "";
                            }
                        });
                    });
                });
                return processes;
            }

            function renderCalendar(year, month) {
                currentYear = year; currentMonth = month;
                currentMonthYearEl.textContent = `${year}년 ${month + 1}월`;
                calendarGrid.innerHTML = '';
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDay; i++) calendarGrid.appendChild(document.createElement('div'));
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day border-t border-l p-2 relative';
                    const dayNumber = document.createElement('span');
                    dayNumber.textContent = day;
                    dayNumber.className = 'text-sm';
                    dayCell.appendChild(dayNumber);
                    const today = new Date();
                    if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                        dayNumber.classList.add('bg-blue-500', 'text-white', 'rounded-full', 'w-6', 'h-6', 'inline-block', 'text-center', 'leading-6');
                    }
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayTasks = tasks.filter(t => t.date === dateStr);
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'mt-1';
                    dayTasks.forEach(task => {
                        const eventEl = document.createElement('div');
                        if (task.taskType === 'linear') {
                            eventEl.className = 'event-item bg-purple-100 text-purple-800 hover:bg-purple-200';
                            eventEl.textContent = `[리니어] ${task.line}/${task.unit || ''}`;
                        } else {
                            eventEl.className = 'event-item bg-green-100 text-green-800 hover:bg-green-200';
                            eventEl.textContent = `[방착판] ${task.line}/${task.unit || ''}/${task.structure || ''}`;
                        }
                        eventEl.dataset.taskId = task.id;
                        eventEl.addEventListener('click', () => openModal(task.id));
                        eventsContainer.appendChild(eventEl);
                    });
                    dayCell.appendChild(eventsContainer);
                    calendarGrid.appendChild(dayCell);
                }
            }
            
            function openModal(taskId) {
                currentTask = JSON.parse(JSON.stringify(tasks.find(t => t.id === taskId))); // Deep copy for temporary edits
                if (!currentTask) return;
                
                visibleProducts = currentTask.visibleProducts || []; 
                
                isEditingBasicInfo = false;
                updateBasicInfoView();
                
                populateBasicInfoFields();

                if (currentTask.taskType === 'linear') {
                    modalUnitWrapper.style.display = 'block';
                    modalStructureWrapper.style.display = 'none';
                    document.getElementById('edit-unit-wrapper').style.display = 'block';
                    document.getElementById('edit-structure-wrapper').style.display = 'none';
                } else {
                    modalUnitWrapper.style.display = 'block';
                    modalStructureWrapper.style.display = 'block';
                    document.getElementById('edit-unit-wrapper').style.display = 'block';
                    document.getElementById('edit-structure-wrapper').style.display = 'block';
                }
                
                renderProcessTable(currentTask.processes, currentTask.taskType);
                modal.style.display = 'flex';
            }
            
            function updateDateInputStyle(input) {
                if (input.value) {
                    input.classList.add('date-input-filled');
                } else {
                    input.classList.remove('date-input-filled');
                }
            }

            function renderProcessTable(processes, taskType) {
                const allProductNames = taskType === 'linear' ? linearProductNames : bafflePlateProductNames;
                const container = document.getElementById('process-table-container');
                container.innerHTML = '';
                if (!processes) return;
                const table = document.createElement('table');
                table.className = 'w-full text-sm border-collapse process-table';
                const thead = document.createElement('thead');
                thead.className = 'bg-slate-100 font-semibold sticky-header';
                
                let headerHTML = `<tr><th class="sticky-col" style="width: 8.333333%;">공정</th><th class="sticky-col-2" style="width: 8.333333%;"></th>`;
                visibleProducts.forEach(productName => {
                    headerHTML += `<th class="product-col"><div class="flex items-center justify-center gap-2">${productName}<button data-remove-product="${productName}" class="text-red-500 font-bold"> &times;</button></div></th>`;
                });
                headerHTML += `<th><div id="add-product-container" class="relative"><button id="add-product-btn" class="bg-blue-500 text-white rounded-md px-2 py-1 text-xs">제품 추가</button></div></th>`;
                headerHTML += `</tr>`;
                thead.innerHTML = headerHTML;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                processDefinitions.forEach(groupDef => {
                    const groupName = groupDef.groupName;
                    const rowSpan = groupDef.rows.length;
                    groupDef.rows.forEach((rowDef, index) => {
                        const rowName = rowDef.name;
                        const tr = document.createElement('tr');
                        if (index === 0) {
                            const tdGroup = document.createElement('td');
                            tdGroup.rowSpan = rowSpan;
                            tdGroup.className = `font-semibold sticky-col ${groupDef.color}`;
                            tdGroup.textContent = groupName.replace('_출하', '_출하 ');
                            tr.appendChild(tdGroup);
                        }
                        const tdRowHeader = document.createElement('td');
                        tdRowHeader.className = `font-semibold sticky-col-2 ${groupDef.color}`;
                        tdRowHeader.textContent = rowName;
                        tr.appendChild(tdRowHeader);
                        
                        visibleProducts.forEach(productName => {
                            const td = document.createElement('td');
                            td.className = `${groupDef.color} product-col`;
                            const productData = processes[groupName]?.products?.[productName]?.[rowName];
                            if (rowDef.type === 'checkbox') {
                                td.className += ' align-top p-2';
                                const checkboxContainer = document.createElement('div');
                                checkboxContainer.className = 'flex flex-col gap-y-2';

                                rowDef.items.forEach(item => {
                                    const itemName = item.label;
                                    const itemData = productData ? productData[itemName] : { checked: false, date: "" };
                                    const isChecked = !!itemData?.checked;
                                    const dateValue = itemData?.date || "";

                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'flex items-center gap-1 justify-between';

                                    const label = document.createElement('label');
                                    label.className = 'checkbox-label';
                                    
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.className = 'form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500';
                                    checkbox.checked = isChecked;
                                    checkbox.dataset.group = groupName; checkbox.dataset.product = productName; checkbox.dataset.row = rowName; checkbox.dataset.detail = itemName;
                                    
                                    label.appendChild(checkbox);
                                    label.appendChild(document.createTextNode(` ${itemName}`));
                                    wrapper.appendChild(label);

                                    if (item.hasDate) {
                                        const dateInput = document.createElement('input');
                                        dateInput.type = 'date';
                                        dateInput.className = 'border rounded p-1 w-24 text-xs border-slate-300';
                                        dateInput.value = dateValue;
                                        dateInput.dataset.group = groupName; dateInput.dataset.product = productName; dateInput.dataset.row = rowName; dateInput.dataset.detailDate = itemName;
                                        
                                        dateInput.addEventListener('input', () => updateDateInputStyle(dateInput));
                                        updateDateInputStyle(dateInput);

                                        wrapper.appendChild(dateInput);
                                    }
                                    checkboxContainer.appendChild(wrapper);
                                });
                                td.appendChild(checkboxContainer);
                            } else {
                                let inputElement;
                                if (rowDef.type === 'textarea') {
                                    inputElement = document.createElement('textarea');
                                    inputElement.className = 'w-full border rounded p-1 h-20 resize-none text-xs border-slate-300';
                                } else {
                                    inputElement = document.createElement('input');
                                    inputElement.type = rowDef.type || 'text';
                                    inputElement.className = 'w-full border rounded p-1 border-slate-300';
                                }
                                inputElement.value = productData || '';
                                inputElement.dataset.group = groupName; inputElement.dataset.product = productName; inputElement.dataset.row = rowName;
                                
                                if (inputElement.type === 'date') {
                                    inputElement.addEventListener('input', () => updateDateInputStyle(inputElement));
                                    updateDateInputStyle(inputElement);
                                }

                                td.appendChild(inputElement);
                            }
                            tr.appendChild(td);
                        });
                        const emptyTd = document.createElement('td');
                        emptyTd.className = 'bg-white';
                        tr.appendChild(emptyTd);
                        tbody.appendChild(tr);
                    });
                });
                table.appendChild(tbody);
                container.appendChild(table);

                const addProductBtn = document.getElementById('add-product-btn');
                addProductBtn.addEventListener('click', () => {
                    const addableProducts = allProductNames.filter(p => !visibleProducts.includes(p));
                    if (addableProducts.length === 0) {
                        showCustomAlert("모든 제품이 추가되었습니다.");
                        return;
                    }

                    const existingDropdown = document.getElementById('product-dropdown');
                    if (existingDropdown) existingDropdown.remove();

                    const dropdown = document.createElement('div');
                    dropdown.id = 'product-dropdown';
                    dropdown.className = 'absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-30 border';
                    addableProducts.forEach(p => {
                        const item = document.createElement('div');
                        item.textContent = p;
                        item.className = 'px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 cursor-pointer';
                        item.onclick = () => {
                            visibleProducts.push(p);
                            renderProcessTable(processes, taskType);
                        };
                        dropdown.appendChild(item);
                    });
                    document.getElementById('add-product-container').appendChild(dropdown);
                });

                document.querySelectorAll('[data-remove-product]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productToRemove = e.target.dataset.removeProduct;
                        visibleProducts = visibleProducts.filter(p => p !== productToRemove);
                        renderProcessTable(processes, taskType);
                    });
                });
            }

            function closeModal() { modal.style.display = 'none'; currentTask = null; }
            function closeNewTaskModal() { newTaskModal.style.display = 'none'; }

            function saveAllChanges() {
                if (!currentTask) return;
                
                if (isEditingBasicInfo) {
                    currentTask.date = document.getElementById('edit-date').value;
                    currentTask.line = document.getElementById('edit-line').value;
                    currentTask.unit = document.getElementById('edit-unit').value;
                    currentTask.structure = document.getElementById('edit-structure').value;
                    currentTask.notes = document.getElementById('edit-notes').value;
                }

                const processesToSave = JSON.parse(JSON.stringify(currentTask.processes));
                const allInputs = modal.querySelectorAll('[data-group][data-product][data-row]');
                allInputs.forEach(input => {
                    const { group, product, row, detail, detailDate } = input.dataset;
                    if (detailDate) return;
                    const productProcess = processesToSave[group]?.products?.[product];
                    if (!productProcess) return;
                    if (detail) {
                        const itemName = detail;
                        if (!productProcess[row]) productProcess[row] = {};
                        if (!productProcess[row][itemName]) productProcess[row][itemName] = {};
                        productProcess[row][itemName].checked = input.checked;
                        const dateInput = modal.querySelector(`[data-detail-date="${itemName}"][data-group="${group}"][data-product="${product}"]`);
                        if (dateInput) {
                            productProcess[row][itemName].date = dateInput.value;
                        }
                    } else {
                        productProcess[row] = input.value;
                    }
                });

                const taskIndex = tasks.findIndex(t => t.id === currentTask.id);
                if(taskIndex > -1){
                    tasks[taskIndex] = {
                        ...tasks[taskIndex],
                        ...currentTask,
                        processes: processesToSave,
                        visibleProducts: visibleProducts
                    };
                    saveTasks();
                }
                showCustomAlert('변경사항이 저장되었습니다.');
                closeModal();
            }
            
            function saveNewTask() {
                const date = document.getElementById('new-task-date').value;
                const line = document.getElementById('new-task-line').value.trim();
                const notes = document.getElementById('new-task-notes').value.trim();
                const unit = document.getElementById('new-task-unit').value.trim();

                if (!date || !line || !unit) {
                    showCustomAlert('반입일자, 반입라인, 반입호기는 필수 항목입니다.');
                    return;
                }

                let taskId, newTask;
                if (currentTaskType === 'baffle-plate') {
                    const structure = document.getElementById('new-task-structure').value.trim();
                    taskId = `${date}-${line}-${unit.replace(/ /g, '_')}`;
                    newTask = { id: taskId, date, line, unit, structure, notes, taskType: 'baffle-plate', processes: generateProcessData('baffle-plate'), visibleProducts: [] };
                } else { // linear
                    taskId = `${date}-${line}-${unit.replace(/ /g, '_')}-linear`;
                    newTask = { id: taskId, date, line, unit, notes, taskType: 'linear', processes: generateProcessData('linear'), visibleProducts: [] };
                }

                if (tasks.some(t => t.id === taskId)) {
                    showCustomAlert('이미 동일한 ID의 작업이 존재합니다.');
                    return;
                }
                
                tasks.push(newTask);
                saveTasks();
                if (!unsubscribe) renderCalendar(currentYear, currentMonth);
                closeNewTaskModal();
            }

            async function deleteTask() {
                if (!currentTask) return;
                const confirmed = await showCustomConfirm(`'${currentTask.line} / ${currentTask.unit}' 작업을 정말로 삭제하시겠습니까?`);
                if (confirmed) {
                    tasks = tasks.filter(t => t.id !== currentTask.id);
                    saveTasks();
                    if (!unsubscribe) renderCalendar(currentYear, currentMonth);
                    closeModal();
                }
            }

            function populateBasicInfoFields() {
                if (!currentTask) return;
                document.getElementById('modal-date').textContent = currentTask.date;
                document.getElementById('modal-line').textContent = currentTask.line;
                document.getElementById('modal-unit').textContent = currentTask.unit;
                document.getElementById('modal-structure').textContent = currentTask.structure;
                document.getElementById('modal-notes').textContent = currentTask.notes;
                document.getElementById('edit-date').value = currentTask.date;
                document.getElementById('edit-line').value = currentTask.line;
                document.getElementById('edit-unit').value = currentTask.unit;
                document.getElementById('edit-structure').value = currentTask.structure;
                document.getElementById('edit-notes').value = currentTask.notes;
            }

            // ✨ 수정된 기본 정보 수정/저장 로직
            function updateBasicInfoView() {
                if (isEditingBasicInfo) {
                    basicInfoDisplay.classList.add('hidden');
                    basicInfoEdit.classList.remove('hidden');
                    editBasicInfoBtn.textContent = '저장';
                    editBasicInfoBtn.classList.remove('bg-slate-200', 'hover:bg-slate-300');
                    editBasicInfoBtn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                } else {
                    basicInfoDisplay.classList.remove('hidden');
                    basicInfoEdit.classList.add('hidden');
                    editBasicInfoBtn.textContent = '수정';
                    editBasicInfoBtn.classList.add('bg-slate-200', 'hover:bg-slate-300');
                    editBasicInfoBtn.classList.remove('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                }
            }

            function startApp() {
                const today = new Date();
                currentYear = today.getFullYear();
                currentMonth = today.getMonth();
                renderCalendar(currentYear, currentMonth);
                prevMonthBtn.addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(currentYear, currentMonth); });
                nextMonthBtn.addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(currentYear, currentMonth); });
                closeModalBtn.addEventListener('click', closeModal);
                saveChangesBtn.addEventListener('click', saveAllChanges);
                deleteTaskBtn.addEventListener('click', deleteTask);
                
                editBasicInfoBtn.addEventListener('click', () => {
                    if (isEditingBasicInfo) {
                        currentTask.date = document.getElementById('edit-date').value;
                        currentTask.line = document.getElementById('edit-line').value;
                        currentTask.unit = document.getElementById('edit-unit').value;
                        currentTask.structure = document.getElementById('edit-structure').value;
                        currentTask.notes = document.getElementById('edit-notes').value;
                        populateBasicInfoFields();
                    }
                    isEditingBasicInfo = !isEditingBasicInfo;
                    updateBasicInfoView();
                });

                const openNewTaskModal = (taskType) => {
                    currentTaskType = taskType;
                    document.getElementById('new-task-date').valueAsDate = new Date();
                    ['new-task-line', 'new-task-unit', 'new-task-structure', 'new-task-notes'].forEach(id => document.getElementById(id).value = '');
                    
                    if (taskType === 'linear') {
                        newTaskModalTitle.textContent = '새 작업 추가 (리니어)';
                        unitWrapper.style.display = 'block';
                        structureWrapper.style.display = 'none';
                    } else {
                        newTaskModalTitle.textContent = '새 작업 추가 (방착판)';
                        unitWrapper.style.display = 'block';
                        structureWrapper.style.display = 'block';
                    }
                    newTaskModal.style.display = 'flex';
                };

                addBafflePlateTaskBtn.addEventListener('click', () => openNewTaskModal('baffle-plate'));
                addLinearTaskBtn.addEventListener('click', () => openNewTaskModal('linear'));

                closeNewTaskModalBtn.addEventListener('click', closeNewTaskModal);
                saveNewTaskBtn.addEventListener('click', saveNewTask);
            }
            
            function initialize() {
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    console.error("Firebase 설정이 없습니다.");
                    statusIndicator.classList.remove('bg-yellow-400');
                    statusIndicator.classList.add('bg-red-500');
                    statusText.textContent = '설정 필요';
                    document.getElementById('calendar-container').style.display = 'none';
                    const guideContainer = document.getElementById('config-guide-container');
                    guideContainer.style.display = 'block';
                    guideContainer.innerHTML = `<div class="text-center p-8 bg-orange-100 text-orange-800 rounded-lg shadow-md mt-4"><h3 class="font-bold text-xl mb-2">⚠️ Firebase 설정 오류</h3><p>실시간 동기화에 필요한 Firebase 구성 정보가 올바르지 않습니다.</p><p class="text-sm mt-2">코드의 'userFirebaseConfig' 부분을 다시 확인해주세요.</p></div>`;
                    return;
                }
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            listenToTasks();
                        } else {
                            try {
                                const token = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) ? __initial_auth_token : null;
                                if (token) { await signInWithCustomToken(auth, token); }
                                else { await signInAnonymously(auth); }
                                listenToTasks();
                            } catch (error) {
                                console.error("인증 실패:", error);
                                statusIndicator.classList.remove('bg-yellow-400', 'bg-green-500');
                                statusIndicator.classList.add('bg-red-500');
                                statusText.textContent = '인증 오류';
                            }
                        }
                    });
                    startApp();
                } catch (error) {
                    console.error("Firebase 초기화 오류:", error);
                    statusIndicator.classList.remove('bg-yellow-400', 'bg-green-500');
                    statusIndicator.classList.add('bg-red-500');
                    statusText.textContent = '초기화 실패';
                }
            }
            initialize();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 공정 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .week-view-table th, .week-view-table td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: center; font-size: 0.8rem; }
        .week-view-table thead th { background-color: #f8fafc; position: sticky; top: 0; }
        .job-item { cursor: pointer; transition: background-color 0.2s; }
        .job-item:hover { background-color: #eff6ff; }
        .detail-table th, .detail-table td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: center; vertical-align: middle; font-size: 0.8rem; }
        .detail-table input, .detail-table select, .detail-table textarea { width: 100%; border: 1px solid #d1d5db; border-radius: 4px; padding: 2px 4px; font-size: 0.8rem; }
        .detail-table textarea { resize: vertical; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="container mx-auto p-4">
        <!-- 헤더 -->
        <header class="flex items-center justify-between mb-4 bg-white p-4 rounded-lg shadow">
            <div class="flex items-center gap-2">
                <button id="prev-week" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">&lt; 이전 주</button>
                <h2 id="current-week-display" class="text-xl font-bold text-gray-800 w-48 text-center"></h2>
                <button id="next-week" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">다음 주 &gt;</button>
                 <button id="today-btn" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">오늘</button>
            </div>
            <div class="flex items-center gap-4">
                 <div id="sync-status" class="text-sm text-gray-500 flex items-center gap-2">
                    <div id="status-indicator" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
                    <span id="status-text">연결 중...</span>
                </div>
                <button id="add-new-job-btn" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">새 납품 추가</button>
            </div>
        </header>

        <!-- 주간 납품 일정 뷰 -->
        <main class="bg-white rounded-lg shadow overflow-x-auto">
            <table id="week-view-table" class="w-full border-collapse week-view-table">
                <thead>
                    <tr id="week-view-header"></tr>
                </thead>
                <tbody id="week-view-body"></tbody>
            </table>
             <div id="loading-spinner" class="text-center p-8 text-gray-500 hidden">
                <p>데이터를 불러오는 중입니다...</p>
            </div>
        </main>
    </div>

    <!-- 상세 정보 및 수정 모달 -->
    <div id="detail-modal" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">상세 공정 현황</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-4 overflow-auto">
                <div id="detail-modal-content"></div>
            </div>
            <div class="p-4 border-t flex justify-between items-center bg-gray-50">
                <button id="delete-job-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">납품 삭제</button>
                <button id="save-changes-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold">변경사항 저장</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc, collection, query, where, getDocs, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 설정 ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyAcIM8AtD9pwtJHH9mqX3q1iDUIGOOUqZ4",
            authDomain: "psprocesscontrol.firebaseapp.com",
            projectId: "psprocesscontrol",
            storageBucket: "psprocesscontrol.appspot.com",
            messagingSenderId: "150463270722",
            appId: "1:150463270722:web:9d5ad3cff85edbab6cc2db",
            measurementId: "G-DQ0RGJRE8C"
        };
        const envFirebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : {};
        const firebaseConfig = envFirebaseConfig.projectId ? envFirebaseConfig : userFirebaseConfig;
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : 'default-app-id';
        let db, auth;

        // --- 앱 상태 및 UI 요소 ---
        let currentStartDate = new Date();
        let allJobs = [];
        let currentJobId = null;
        let unsubscribe = null;

        const weekDisplay = document.getElementById('current-week-display');
        const weekHeader = document.getElementById('week-view-header');
        const weekBody = document.getElementById('week-view-body');
        const detailModal = document.getElementById('detail-modal');
        const detailModalContent = document.getElementById('detail-modal-content');

        // --- 데이터 구조 정의 ---
        const partNames = ["상판", "견시창", "리플렉터", "구성품", "전수"];
        const processSteps = {
            posung: { name: "포승", fields: [{ name: "출고 특이사항", type: "text" }, { name: "출고 완료일", type: "date" }] },
            inhyun: { name: "인현산업", fields: [{ name: "입고일", type: "date" }] },
            tkg: { name: "TKG", fields: [{ name: "오븐 시작", type: "date" }, { name: "오븐 완료", type: "date" }, { name: "포장 시작", type: "date" }, { name: "포장 완료", type: "date" }, { name: "C/R, 특이사항", type: "textarea" }] },
            loading: { name: "상차", fields: [{ name: "상차 상태", type: "text" }] }
        };

        // --- 날짜 관련 헬퍼 함수 ---
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday is start of week
            return new Date(d.setDate(diff));
        }
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        function getWeekDateObjects(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                dates.push(d);
            }
            return dates;
        }

        // --- 렌더링 함수 ---
        function renderWeekView() {
            const startDate = getStartOfWeek(currentStartDate);
            const weekDates = getWeekDateObjects(startDate);
            const endDate = weekDates[6];
            weekDisplay.textContent = `${formatDate(startDate)} ~ ${formatDate(endDate)}`;

            // 헤더 렌더링
            weekHeader.innerHTML = `
                <tr class="bg-gray-100">
                    ${weekDates.map(d => `<th class="p-2">${['일', '월', '화', '수', '목', '금', '토'][d.getDay()]}<br>${d.getMonth() + 1}/${d.getDate()}</th>`).join('')}
                </tr>
                <tr class="bg-gray-50">
                    ${weekDates.map(() => `<th class="p-1">Line</th><th class="p-1">호기</th><th class="p-1">품목</th><th class="p-1">상태</th><th class="p-1">시간</th>`).join('')}
                </tr>
            `;

            // 바디 렌더링
            const jobsByDate = {};
            allJobs.forEach(job => {
                const jobDate = job.entryDate.split(' ')[0];
                if (!jobsByDate[jobDate]) jobsByDate[jobDate] = [];
                jobsByDate[jobDate].push(job);
            });

            const maxRows = Math.max(10, ...Object.values(jobsByDate).map(arr => arr.length));
            let tableHtml = '';
            for (let i = 0; i < maxRows; i++) {
                tableHtml += '<tr>';
                weekDates.forEach(d => {
                    const dateStr = formatDate(d);
                    const job = jobsByDate[dateStr]?.[i];
                    if (job) {
                        tableHtml += `
                            <td class="job-item" data-id="${job.id}" colspan="5">
                                <div class="grid grid-cols-5 gap-1">
                                    <span>${job.line || ''}</span>
                                    <span>${job.unit || ''}</span>
                                    <span class="col-span-2">${job.mainItemName || ''}</span>
                                    <span>${job.entryTime || ''}</span>
                                </div>
                            </td>`;
                    } else {
                        tableHtml += `<td colspan="5" class="h-8">&nbsp;</td>`;
                    }
                });
                tableHtml += '</tr>';
            }
            weekBody.innerHTML = tableHtml;

            // 이벤트 리스너 추가
            document.querySelectorAll('.job-item').forEach(item => {
                item.addEventListener('click', () => openDetailModal(item.dataset.id));
            });
        }

        function renderDetailModal(jobId) {
            const job = allJobs.find(j => j.id === jobId);
            if (!job) return;
            currentJobId = jobId;

            let tableHtml = `<table class="w-full detail-table">`;
            // 기본 정보
            tableHtml += `
                <tr class="bg-gray-50">
                    <td class="p-2" colspan="5">
                        <div class="grid grid-cols-4 gap-4">
                            <div><label class="font-bold">Line</label><input type="text" id="detail-line" value="${job.line || ''}"></div>
                            <div><label class="font-bold">호기</label><input type="text" id="detail-unit" value="${job.unit || ''}"></div>
                            <div><label class="font-bold">구조/특이사항</label><input type="text" id="detail-structure" value="${job.structure || ''}"></div>
                            <div><label class="font-bold">반입일 (YYYY-MM-DD HH:MM)</label><input type="text" id="detail-entryDate" value="${job.entryDate || ''}"></div>
                        </div>
                    </td>
                </tr>
            `;

            // 헤더
            tableHtml += `<thead class="bg-gray-100"><tr>`;
            tableHtml += `<th rowspan="2">구분</th><th rowspan="2">출고가능여부</th>`;
            Object.values(processSteps).forEach(step => {
                tableHtml += `<th colspan="${step.fields.length}">${step.name}</th>`;
            });
            tableHtml += `</tr><tr class="bg-gray-50">`;
            Object.values(processSteps).forEach(step => {
                step.fields.forEach(field => {
                    tableHtml += `<th>${field.name}</th>`;
                });
            });
            tableHtml += `</tr></thead>`;
            
            // 바디
            tableHtml += `<tbody>`;
            partNames.forEach((partName, partIndex) => {
                const partData = job.parts.find(p => p.name === partName) || { name: partName };
                tableHtml += `<tr>`;
                tableHtml += `<td class="font-bold">${partName}</td>`;
                tableHtml += `<td><input type="text" data-part="${partName}" data-field="deliveryStatus" value="${partData.deliveryStatus || ''}"></td>`;
                
                Object.keys(processSteps).forEach(stepKey => {
                    processSteps[stepKey].fields.forEach(field => {
                        const fieldKey = `${stepKey}_${field.name.replace(/[^a-zA-Z0-9]/g, '')}`;
                        const value = partData[stepKey] ? partData[stepKey][fieldKey] || '' : '';
                        if (field.type === 'textarea') {
                            tableHtml += `<td><textarea data-part="${partName}" data-step="${stepKey}" data-field="${fieldKey}" rows="2">${value}</textarea></td>`;
                        } else {
                            tableHtml += `<td><input type="${field.type === 'date' ? 'date' : 'text'}" data-part="${partName}" data-step="${stepKey}" data-field="${fieldKey}" value="${value}"></td>`;
                        }
                    });
                });
                tableHtml += `</tr>`;
            });
            tableHtml += `</tbody></table>`;

            detailModalContent.innerHTML = tableHtml;
            detailModal.style.display = 'flex';
        }

        // --- 데이터 처리 함수 ---
        async function saveChanges() {
            if (!currentJobId) return;
            
            const job = allJobs.find(j => j.id === currentJobId);
            const updatedJob = JSON.parse(JSON.stringify(job)); // Deep copy

            updatedJob.line = document.getElementById('detail-line').value;
            updatedJob.unit = document.getElementById('detail-unit').value;
            updatedJob.structure = document.getElementById('detail-structure').value;
            const entryDate = document.getElementById('detail-entryDate').value;
            updatedJob.entryDate = entryDate;
            updatedJob.entryTime = entryDate.split(' ')[1] || '';
            updatedJob.mainItemName = `${updatedJob.structure} ${updatedJob.line}`; // 예시

            const updatedParts = [];
            partNames.forEach(partName => {
                const partData = { name: partName };
                const inputs = detailModalContent.querySelectorAll(`[data-part="${partName}"]`);
                inputs.forEach(input => {
                    if (input.dataset.step) { // 공정 데이터
                        if (!partData[input.dataset.step]) partData[input.dataset.step] = {};
                        partData[input.dataset.step][input.dataset.field] = input.value;
                    } else { // 일반 필드 (출고가능여부)
                        partData[input.dataset.field] = input.value;
                    }
                });
                updatedParts.push(partData);
            });
            updatedJob.parts = updatedParts;

            const docRef = doc(db, "jobs", currentJobId);
            await setDoc(docRef, updatedJob);
            
            closeDetailModal();
        }

        async function addNewJob() {
            const newJob = {
                line: "신규", unit: "호기", structure: "구조",
                entryDate: formatDate(new Date()) + " 09:00",
                entryTime: "09:00", mainItemName: "신규 품목",
                parts: partNames.map(name => ({ name: name }))
            };
            const docRef = await addDoc(collection(db, "jobs"), newJob);
            openDetailModal(docRef.id);
        }

        async function deleteJob() {
            if (!currentJobId) return;
            if (confirm("이 납품 건을 정말 삭제하시겠습니까?")) {
                await deleteDoc(doc(db, "jobs", currentJobId));
                closeDetailModal();
            }
        }

        // --- 모달 제어 ---
        function openDetailModal(jobId) {
            const job = allJobs.find(j => j.id === jobId);
            if(job) renderDetailModal(jobId);
        }
        function closeDetailModal() {
            detailModal.style.display = 'none';
            currentJobId = null;
        }

        // --- 이벤트 리스너 설정 ---
        function setupEventListeners() {
            document.getElementById('prev-week').addEventListener('click', () => {
                currentStartDate.setDate(currentStartDate.getDate() - 7);
                renderWeekView();
            });
            document.getElementById('next-week').addEventListener('click', () => {
                currentStartDate.setDate(currentStartDate.getDate() + 7);
                renderWeekView();
            });
            document.getElementById('today-btn').addEventListener('click', () => {
                currentStartDate = new Date();
                renderWeekView();
            });
            document.getElementById('add-new-job-btn').addEventListener('click', addNewJob);
            document.getElementById('close-modal').addEventListener('click', closeDetailModal);
            document.getElementById('save-changes-btn').addEventListener('click', saveChanges);
            document.getElementById('delete-job-btn').addEventListener('click', deleteJob);
        }

        // --- 앱 초기화 ---
        async function initialize() {
            if (!firebaseConfig || !firebaseConfig.projectId) {
                document.body.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100">Firebase 설정이 올바르지 않습니다. 코드의 userFirebaseConfig 객체를 확인해주세요.</div>`;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        if (unsubscribe) unsubscribe();
                        const q = collection(db, "jobs");
                        unsubscribe = onSnapshot(q, (querySnapshot) => {
                            allJobs = [];
                            querySnapshot.forEach((doc) => {
                                allJobs.push({ id: doc.id, ...doc.data() });
                            });
                            renderWeekView();
                            document.getElementById('status-indicator').classList.remove('bg-yellow-400', 'animate-pulse');
                            document.getElementById('status-indicator').classList.add('bg-green-500');
                            document.getElementById('status-text').textContent = '실시간 동기화 중';
                        });
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed", err));
                    }
                });

                currentStartDate = getStartOfWeek(new Date());
                setupEventListeners();
                renderWeekView();

            } catch (error) {
                console.error("Initialization failed:", error);
                document.body.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100">앱 초기화에 실패했습니다. 콘솔 로그를 확인해주세요.</div>`;
            }
        }

        initialize();
    </script>
</body>
</html>
